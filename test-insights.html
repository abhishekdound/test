<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Insights Test - Text Selection & Gemini API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .sample-text {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
            line-height: 1.6;
            user-select: text;
            cursor: text;
        }
        .selected-text-display {
            background: #e8f4fd;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 5px;
            margin: 15px 0;
            min-height: 50px;
            display: none;
        }
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #2980b9;
        }
        .button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .insights-container {
            margin-top: 20px;
            display: none;
        }
        .insight-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .insight-type {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .insight-content {
            color: #555;
            line-height: 1.5;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .manual-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.backend {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.frontend {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† LLM Insights Test - Text Selection & Gemini API</h1>
            <p>Test text selection and AI-powered insights generation using your backend LLM services</p>
        </div>

        <!-- Service Status -->
        <div class="test-section">
            <h3>üîç Service Status</h3>
            <div id="backendStatus" class="status backend">Checking backend status...</div>
            <div id="frontendStatus" class="status frontend">Checking frontend status...</div>
        </div>

        <!-- Text Selection Test -->
        <div class="test-section">
            <h3>üìù Text Selection Test</h3>
            <p>Select text from the sample content below to test text selection detection:</p>
            
            <div class="sample-text" id="sampleText">
                <strong>Artificial Intelligence in Healthcare</strong><br><br>
                
                Artificial Intelligence (AI) is revolutionizing the healthcare industry by enabling early disease detection, personalized treatment plans, and automated medical imaging analysis. Machine learning algorithms can now process vast amounts of patient data to identify patterns that human doctors might miss.
                
                <br><br><strong>Key Applications:</strong><br>
                ‚Ä¢ <strong>Medical Imaging:</strong> AI systems can detect tumors, fractures, and other abnormalities in X-rays, MRIs, and CT scans with remarkable accuracy.<br>
                ‚Ä¢ <strong>Drug Discovery:</strong> AI accelerates the process of identifying potential new drugs and predicting their effectiveness.<br>
                ‚Ä¢ <strong>Personalized Medicine:</strong> Machine learning models analyze genetic data to create tailored treatment plans for individual patients.<br>
                ‚Ä¢ <strong>Predictive Analytics:</strong> AI can predict patient outcomes and identify those at risk of developing certain conditions.
                
                <br><br>This technology is particularly promising in radiology, where AI systems can detect tumors and other abnormalities with high accuracy, often outperforming human radiologists in speed and consistency. The integration of AI in healthcare is expected to improve patient outcomes while reducing costs and increasing efficiency across the healthcare system.
            </div>
            
            <div class="selected-text-display" id="selectedTextDisplay">
                <strong>Selected Text:</strong> <span id="selectedTextContent">No text selected</span>
            </div>
            
            <button class="button" onclick="checkSelectedText()">üîç Check Selected Text</button>
            <button class="button" onclick="showManualInput()">‚úèÔ∏è Manual Input</button>
            <button class="button" onclick="clearSelection()">üóëÔ∏è Clear Selection</button>
        </div>

        <!-- Manual Input Section -->
        <div class="test-section" id="manualInputSection" style="display: none;">
            <h3>‚úèÔ∏è Manual Text Input</h3>
            <textarea class="manual-input" id="manualTextInput" rows="4" placeholder="Enter or paste your text here for analysis..."></textarea>
            <button class="button" onclick="useManualText()">‚úÖ Use This Text</button>
            <button class="button" onclick="hideManualInput()">‚ùå Cancel</button>
        </div>

        <!-- Insights Generation Test -->
        <div class="test-section">
            <h3>ü§ñ LLM Insights Generation</h3>
            <p>Generate AI-powered insights from the selected text using your backend's LLM services:</p>
            
            <button class="button" onclick="generateBackendInsights()" id="backendBtn">üîß Backend LLM Insights</button>
            <button class="button" onclick="generateFrontendInsights()" id="frontendBtn">üåê Frontend API Insights</button>
            <button class="button" onclick="generateDirectGemini()" id="geminiBtn">üîë Direct Gemini API</button>
            
            <div class="insights-container" id="insightsContainer">
                <h4>üìä Generated Insights:</h4>
                <div id="insightsContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSelectedText = '';
        let isGenerating = false;

        // Check service status on page load
        window.addEventListener('load', async () => {
            await checkServiceStatus();
            setupTextSelection();
        });

        // Setup text selection detection
        function setupTextSelection() {
            const sampleText = document.getElementById('sampleText');
            
            // Listen for selection changes
            document.addEventListener('selectionchange', handleTextSelection);
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('keyup', handleTextSelection);
            
            // Also listen on the sample text specifically
            sampleText.addEventListener('mouseup', handleTextSelection);
            sampleText.addEventListener('keyup', handleTextSelection);
        }

        // Handle text selection
        function handleTextSelection() {
            const selection = window.getSelection();
            if (selection && selection.toString().trim()) {
                const selectedText = selection.toString().trim();
                if (selectedText !== currentSelectedText) {
                    currentSelectedText = selectedText;
                    displaySelectedText(selectedText);
                }
            }
        }

        // Display selected text
        function displaySelectedText(text) {
            const display = document.getElementById('selectedTextDisplay');
            const content = document.getElementById('selectedTextContent');
            
            content.textContent = text;
            display.style.display = 'block';
            
            console.log('‚úÖ Text selected:', text);
        }

        // Check selected text manually
        function checkSelectedText() {
            const selection = window.getSelection();
            if (selection && selection.toString().trim()) {
                const selectedText = selection.toString().trim();
                currentSelectedText = selectedText;
                displaySelectedText(selectedText);
            } else {
                alert('No text is currently selected. Please select some text first.');
            }
        }

        // Show manual input
        function showManualInput() {
            document.getElementById('manualInputSection').style.display = 'block';
        }

        // Hide manual input
        function hideManualInput() {
            document.getElementById('manualInputSection').style.display = 'none';
        }

        // Use manual text
        function useManualText() {
            const manualText = document.getElementById('manualTextInput').value.trim();
            if (manualText) {
                currentSelectedText = manualText;
                displaySelectedText(manualText);
                hideManualInput();
            } else {
                alert('Please enter some text first.');
            }
        }

        // Clear selection
        function clearSelection() {
            window.getSelection().removeAllRanges();
            currentSelectedText = '';
            document.getElementById('selectedTextDisplay').style.display = 'none';
            document.getElementById('insightsContainer').style.display = 'none';
        }

        // Check service status
        async function checkServiceStatus() {
            // Check backend
            try {
                const backendResponse = await fetch('http://localhost:8080/api/frontend/health');
                document.getElementById('backendStatus').innerHTML = '‚úÖ Backend is running (Port 8080)';
                document.getElementById('backendStatus').style.background = '#d4edda';
                document.getElementById('backendStatus').style.color = '#155724';
            } catch (error) {
                document.getElementById('backendStatus').innerHTML = '‚ùå Backend is not available (Port 8080)';
                document.getElementById('backendStatus').style.background = '#f8d7da';
                document.getElementById('backendStatus').style.color = '#721c24';
            }

            // Check frontend
            try {
                const frontendResponse = await fetch('http://localhost:3000/api/generate-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: 'test', useSelectedText: false })
                });
                document.getElementById('frontendStatus').innerHTML = '‚úÖ Frontend is running (Port 3000)';
                document.getElementById('frontendStatus').style.background = '#d4edda';
                document.getElementById('frontendStatus').style.color = '#155724';
            } catch (error) {
                document.getElementById('frontendStatus').innerHTML = '‚ùå Frontend is not available (Port 3000)';
                document.getElementById('frontendStatus').style.background = '#f8d7da';
                document.getElementById('frontendStatus').style.color = '#721c24';
            }
        }

        // Generate backend insights
        async function generateBackendInsights() {
            if (!currentSelectedText) {
                alert('Please select some text first or use manual input.');
                return;
            }

            if (isGenerating) return;
            isGenerating = true;
            
            const btn = document.getElementById('backendBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                const response = await fetch('http://localhost:8080/api/frontend/insights/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        sectionContent: currentSelectedText,
                        persona: 'researcher',
                        jobToBeDone: 'selected text analysis'
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    displayInsights(data.insights, 'Backend LLM Service');
                } else {
                    throw new Error(`Backend error: ${response.status}`);
                }
            } catch (error) {
                showError(`Backend LLM service error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîß Backend LLM Insights';
                isGenerating = false;
            }
        }

        // Generate frontend insights
        async function generateFrontendInsights() {
            if (!currentSelectedText) {
                alert('Please select some text first or use manual input.');
                return;
            }

            if (isGenerating) return;
            isGenerating = true;
            
            const btn = document.getElementById('frontendBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                const response = await fetch('http://localhost:3000/api/generate-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: currentSelectedText,
                        useSelectedText: true,
                        analysisType: 'comprehensive'
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    displayInsights(data.insights, 'Frontend API');
                } else {
                    throw new Error(`Frontend error: ${response.status}`);
                }
            } catch (error) {
                showError(`Frontend API error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üåê Frontend API Insights';
                isGenerating = false;
            }
        }

        // Generate direct Gemini insights
        async function generateDirectGemini() {
            if (!currentSelectedText) {
                alert('Please select some text first or use manual input.');
                return;
            }

            if (isGenerating) return;
            isGenerating = true;
            
            const btn = document.getElementById('geminiBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                const geminiApiKey = 'AIzaSyBvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQ'; // Your API key
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Analyze this selected text and provide insights in JSON format:
                                
                                TEXT: "${currentSelectedText}"
                                
                                Please provide insights in this format:
                                {
                                    "keyInsights": ["Key insight 1", "Key insight 2"],
                                    "didYouKnow": ["Interesting fact 1", "Interesting fact 2"],
                                    "connections": ["Connection 1", "Connection 2"],
                                    "inspirations": ["Inspiration 1", "Inspiration 2"]
                                }`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        }
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        const geminiText = data.candidates[0].content.parts[0].text;
                        
                        // Try to parse JSON from response
                        const jsonMatch = geminiText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            displayInsights(parsed, 'Direct Gemini API');
                        } else {
                            showError('Could not parse JSON response from Gemini API');
                        }
                    } else {
                        showError('Invalid response from Gemini API');
                    }
                } else {
                    throw new Error(`Gemini API error: ${response.status}`);
                }
            } catch (error) {
                showError(`Direct Gemini API error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîë Direct Gemini API';
                isGenerating = false;
            }
        }

        // Display insights
        function displayInsights(insights, source) {
            const container = document.getElementById('insightsContainer');
            const content = document.getElementById('insightsContent');
            
            let html = `<div class="success">‚úÖ Insights generated successfully using ${source}</div>`;
            
            if (typeof insights === 'object') {
                Object.keys(insights).forEach(key => {
                    if (Array.isArray(insights[key])) {
                        html += `<div class="insight-card">
                            <div class="insight-type">${key.toUpperCase()}</div>`;
                        
                        insights[key].forEach(insight => {
                            html += `<div class="insight-content">‚Ä¢ ${insight}</div>`;
                        });
                        
                        html += '</div>';
                    }
                });
            }
            
            content.innerHTML = html;
            container.style.display = 'block';
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('insightsContainer');
            const content = document.getElementById('insightsContent');
            
            content.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            container.style.display = 'block';
        }
    </script>
</body>
</html>
